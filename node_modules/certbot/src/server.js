// Importações módulos:
const express = require("express");
const cors = require("cors");
var shell = require("shelljs");
const server = express();
server.use(cors());
server.use(express.json());

const porta = 13100;

server.listen(porta);
console.log(`Listenning at port: ${porta}`);

server.get("/nginx", (req, res) => {
  // Recuperando o nome do projeto
  const project = req.query.projeto;

  //   Comando para parar o NGINX na porta 80
  const stopNginx80 =
    "sudo /opt/nginx/sbin/nginx -s stop -c /opt/nginx/conf/nginx-80.conf";

  // Comando para gerar o certificado do Gama
  var certGama = `sudo letsencrypt certonly --standalone -d gama.${project}.prodatamobility.com.br`;

  //   Comando para gerar o certificado do Portal
  var certPortal = `sudo letsencrypt certonly --standalone -d mccportal.${project}.prodatamobility.com.br`;

  //   Comando para restartar a porta 443
  const reload443 = "sudo /opt/nginx/sbin/nginx -s reload";

  //   Comando para startat o NGINX
  const startNginx80 =
    "sudo /opt/nginx/sbin/nginx -c /opt/nginx/conf/nginx-80.conf";

  // Todos os comandos
  const command = `${certGama} && ${certPortal} && ${reload443}`;

  shell.exec(stopNginx80, function(code, stdout, stderr) {
    console.log("Exit code:", code);
    if (code == 1) {
      shell.exec(startNginx80, function(code, stdout, stderr) {
        console.log("Exit code:", code);
        console.log("Program output:", stdout);
        console.log("Program stderr:", stderr);
      });
    } else {
      shell.exec(command, function(code, stdout, stderr) {
        console.log("Exit code:", code);
        if (code == 1) {
          shell.exec(startNginx80, function(code, stdout, stderr) {
            console.log("Exit code:", code);
            console.log("Program output:", stdout);
            console.log("Program stderr:", stderr);
          });
        } else {
          shell.exec(startNginx80, function(code, stdout, stderr) {
            console.log("Exit code:", code);
            console.log("Program output:", stdout);
            console.log("Program stderr:", stderr);
          });
        }
        console.log("Program output:", stdout);
        console.log("Program stderr:", stderr);
      });
    }
    console.log("Program output:", stdout);
    console.log("Program stderr:", stderr);
  });

  return res.json({ Status: "ok" });
});
